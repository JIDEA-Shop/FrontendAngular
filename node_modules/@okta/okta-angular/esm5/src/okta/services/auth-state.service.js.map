{"version":3,"file":"auth-state.service.js","sourceRoot":"","sources":["../../../../src/okta/services/auth-state.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, OnDestroy, Inject } from '@angular/core';\nimport { AuthState, OktaAuth, UserClaims } from '@okta/okta-auth-js';\nimport { BehaviorSubject, Observable } from 'rxjs';\nimport { mergeMap } from 'rxjs/operators';\nimport { OKTA_AUTH } from '../models/okta.config';\n\nconst defaultAuthState = {\n  isAuthenticated: false\n};\n\nexport type Groups = string | string[] | { [key: string]: string[] };\n\n@Injectable()\nexport class OktaAuthStateService implements OnDestroy {\n  private _authState: BehaviorSubject<AuthState> = new BehaviorSubject<AuthState>(defaultAuthState);\n  \n  // only expose readonly property\n  public readonly authState$: Observable<AuthState> = this._authState.asObservable();\n\n  constructor(@Inject(OKTA_AUTH) private oktaAuth: OktaAuth) {\n    this.updateAuthState = this.updateAuthState.bind(this);\n\n    // set initial authState\n    const initialAuthState = this.oktaAuth.authStateManager.getAuthState() || defaultAuthState;\n    this._authState.next(initialAuthState);\n\n    // subscribe to future changes\n    this.oktaAuth.authStateManager.subscribe(this.updateAuthState);\n  }\n\n  ngOnDestroy(): void {\n    this.oktaAuth.authStateManager.unsubscribe(this.updateAuthState);\n  }\n\n  // Observes as true when any group input can match groups from user claims \n  hasAnyGroups(groups: Groups): Observable<boolean> {\n    return this.authState$.pipe(\n      mergeMap(async ({ isAuthenticated, idToken }) => {\n        // return false when not authenticated or openid is not in scopes\n        if (!isAuthenticated || !idToken) {\n          return false;\n        }\n\n        // transform inputs to consistent object format\n        if (typeof groups === 'string') {\n          groups = { groups: [groups] };\n        }\n        if (Array.isArray(groups)) {\n          groups = { groups };\n        }\n\n        const key = Object.keys(groups)[0] as keyof UserClaims;\n        const value = groups[key];\n\n        // groups or custom claims is available in idToken\n        if (idToken.claims[key]) {\n          return value.some((authority: string) => (idToken.claims[key] as unknown as string[]).includes(authority));\n        }\n\n        // try /userinfo endpoint when thin idToken (no groups claim) is returned\n        // https://developer.okta.com/docs/concepts/api-access-management/#tokens-and-scopes\n        const userInfo = await this.oktaAuth.getUser();\n        if (!userInfo[key]) {\n          return false;\n        }\n        return value.some((authority: string) => (userInfo[key] as unknown as string[]).includes(authority));\n      })\n    );\n  }\n\n  private updateAuthState(authState: AuthState): void {\n    this._authState.next(authState);\n  }\n}\n"]}