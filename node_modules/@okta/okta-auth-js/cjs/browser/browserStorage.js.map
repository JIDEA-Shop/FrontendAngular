{"version":3,"file":"browserStorage.js","names":["storageUtil","getHttpCache","getPKCEStorage","browserHasLocalStorage","storage","getLocalStorage","testStorage","e","browserHasSessionStorage","getSessionStorage","testStorageType","storageType","supported","getStorageByType","options","storageProvider","getCookieStorage","getInMemoryStorage","AuthSdkError","findStorageType","types","curType","nextType","shift","length","warn","isIE11OrLess","window","onstorage","localStorage","sessionStorage","secure","sameSite","sessionCookie","getItem","get","setItem","key","value","expiresAt","set","removeItem","delete","isSharedStorage","useSeparateCookies","data","forEach","k","replace","JSON","parse","existingValues","storageKey","valueToStore","inMemoryStore","name","cookieOptions","path","Date","expires","Cookies","arguments","remove"],"sources":["../../../lib/browser/browserStorage.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-non-null-assertion */\n/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n *\n */\n\nimport Cookies from 'js-cookie';\nimport AuthSdkError from '../errors/AuthSdkError';\nimport {\n  StorageProvider,\n  StorageOptions,\n  PKCEStorage,\n  CookieOptions,\n  SimpleStorage,\n  StorageType,\n  BrowserStorageUtil,\n  CookieStorage\n} from '../types';\nimport { warn } from '../util';\nimport { isIE11OrLess } from '../features';\n\n// Building this as an object allows us to mock the functions in our tests\nvar storageUtil: BrowserStorageUtil = {\n\n  // These are shimmed in `OktaAuthBase.ts`\n  getHttpCache(): StorageProvider {\n    return null as never as StorageProvider;\n  },\n\n  getPKCEStorage(): PKCEStorage {\n    return null as never as PKCEStorage;\n  },\n\n  // IE11 bug that Microsoft doesn't plan to fix\n  // https://connect.microsoft.com/IE/Feedback/Details/1496040\n  browserHasLocalStorage: function() {\n    try {\n      var storage = this.getLocalStorage();\n      return this.testStorage(storage);\n    } catch (e) {\n      return false;\n    }\n  },\n\n  browserHasSessionStorage: function() {\n    try {\n      var storage = this.getSessionStorage();\n      return this.testStorage(storage);\n    } catch (e) {\n      return false;\n    }\n  },\n\n  testStorageType: function(storageType: StorageType): boolean {\n    var supported = false;\n    switch (storageType) {\n      case 'sessionStorage':\n        supported = this.browserHasSessionStorage();\n        break;\n      case 'localStorage':\n        supported = this.browserHasLocalStorage();\n        break;\n      case 'cookie':\n      case 'memory':\n        supported = true;\n        break;\n      default:\n        supported = false;\n        break;\n    }\n    return supported;\n  },\n\n  getStorageByType: function(storageType: StorageType, options?: StorageOptions): SimpleStorage {\n    let storageProvider;\n    switch (storageType) {\n      case 'sessionStorage':\n        storageProvider = this.getSessionStorage();\n        break;\n      case 'localStorage':\n        storageProvider = this.getLocalStorage();\n        break;\n      case 'cookie':\n        storageProvider = this.getCookieStorage(options);\n        break;\n      case 'memory':\n        storageProvider = this.getInMemoryStorage();\n        break;\n      default:\n        throw new AuthSdkError(`Unrecognized storage option: ${storageType}`);\n        break;\n    }\n    return storageProvider;\n  },\n\n  findStorageType: function(types: StorageType[]) {\n    let curType;\n    let nextType;\n    \n    types = types.slice(); // copy array\n    curType = types.shift();\n    nextType = types.length ? types[0] : null;\n    if (!nextType) {\n      return curType;\n    }\n\n    if (this.testStorageType(curType)) {\n      return curType;\n    }\n\n    // preferred type was unsupported.\n    warn(`This browser doesn't support ${curType}. Switching to ${nextType}.`);\n\n    // fallback to the next type. this is a recursive call\n    return this.findStorageType(types);\n  },\n\n  getLocalStorage: function() {\n    // Workaound for synchronization issue of LocalStorage cross tabs in IE11\n    if (isIE11OrLess() && !window.onstorage) {\n      window.onstorage = function() {};\n    }\n    \n    return localStorage;\n  },\n\n  getSessionStorage: function() {\n    return sessionStorage;\n  },\n\n  // Provides webStorage-like interface for cookies\n  getCookieStorage: function(options): CookieStorage {\n    const secure = options!.secure;\n    const sameSite = options!.sameSite;\n    const sessionCookie = options!.sessionCookie;\n    if (typeof secure === 'undefined' || typeof sameSite === 'undefined') {\n      throw new AuthSdkError('getCookieStorage: \"secure\" and \"sameSite\" options must be provided');\n    }\n    const storage: CookieStorage = {\n      getItem: this.storage.get,\n      setItem: (key, value, expiresAt = '2200-01-01T00:00:00.000Z') => {\n        // By defauilt, cookie shouldn't expire\n        expiresAt = (sessionCookie ? null : expiresAt) as string;\n        this.storage.set(key, value, expiresAt, {\n          secure: secure, \n          sameSite: sameSite,\n        });\n      },\n      removeItem: (key) => {\n        this.storage.delete(key);\n      },\n      // TODO: remove - https://oktainc.atlassian.net/browse/OKTA-529631\n      isSharedStorage: () => true\n    };\n\n    if (!options!.useSeparateCookies) {\n      return storage;\n    }\n\n    // Tokens are stored separately because cookies have size limits.\n    // Can only be used when storing an object value. Object properties will be saved to separate cookies.\n    // Each property of the object must also be an object.\n    return {\n      getItem: function(key) {\n        var data = storage.getItem(); // read all cookies\n        var value = {};\n        Object.keys(data).forEach(k => {\n          if (k.indexOf(key!) === 0) { // filter out unrelated cookies\n            value[k.replace(`${key}_`, '')] = JSON.parse(data[k]); // populate with cookie data\n          }\n        });\n        return JSON.stringify(value);\n      },\n      setItem: function(key, value) {\n        var existingValues = JSON.parse(this.getItem(key));\n        value = JSON.parse(value);\n        // Set key-value pairs from input to cookies\n        Object.keys(value).forEach(k => {\n          var storageKey = key + '_' + k;\n          var valueToStore = JSON.stringify(value[k]);\n          storage.setItem(storageKey, valueToStore);\n          delete existingValues[k];\n        });\n        // Delete unmatched keys from existing cookies\n        Object.keys(existingValues).forEach(k => {\n          storage.removeItem(key + '_' + k);\n        });\n      },\n      removeItem: function(key) {\n        var existingValues = JSON.parse(this.getItem(key));\n        Object.keys(existingValues).forEach(k => {\n          storage.removeItem(key + '_' + k);\n        });\n      },\n      // TODO: remove - https://oktainc.atlassian.net/browse/OKTA-529631\n      isSharedStorage: () => true\n    };\n  },\n\n  // Provides an in-memory solution\n  inMemoryStore: {}, // override this for a unique memory store per instance\n  getInMemoryStorage: function() {\n    return {\n      getItem: (key) => {\n        return this.inMemoryStore[key];\n      },\n      setItem: (key, value) => {\n        this.inMemoryStore[key] = value;\n      },\n      // TODO: remove - https://oktainc.atlassian.net/browse/OKTA-529631\n      isSharedStorage: () => false\n    };\n  },\n\n  testStorage: function(storage) {\n    var key = 'okta-test-storage';\n    try {\n      storage.setItem(key, key);\n      storage.removeItem(key);\n      return true;\n    } catch (e) {\n      return false;\n    }\n  },\n\n  storage: {\n    set: function(name: string, value: string, expiresAt: string, options: CookieOptions): string {\n      const { sameSite, secure } = options;\n      if (typeof secure === 'undefined' || typeof sameSite === 'undefined') {\n        throw new AuthSdkError('storage.set: \"secure\" and \"sameSite\" options must be provided');\n      }\n      var cookieOptions: CookieOptions = {\n        path: options.path || '/',\n        secure,\n        sameSite\n      };\n\n      // eslint-disable-next-line no-extra-boolean-cast\n      if (!!(Date.parse(expiresAt))) {\n        // Expires value can be converted to a Date object.\n        //\n        // If the 'expiresAt' value is not provided, or the value cannot be\n        // parsed as a Date object, the cookie will set as a session cookie.\n        cookieOptions.expires = new Date(expiresAt);\n      }\n\n      Cookies.set(name, value, cookieOptions);\n      return this.get(name);\n    },\n\n    get: function(name?: string): string {\n      // return all cookies when no args is provided\n      if (!arguments.length) {\n        return Cookies.get();\n      }\n      return Cookies.get(name);\n    },\n\n    delete: function(name: string): string {\n      return Cookies.remove(name, { path: '/' });\n    }\n  }\n};\n\nexport default storageUtil;\n"],"mappings":"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"}