{"version":3,"file":"StorageManager.js","names":["logServerSideMemoryStorageWarning","options","isBrowser","storageProvider","warn","StorageManager","constructor","storageManagerOptions","cookieOptions","storageUtil","getOptionsForSection","sectionName","overrideOptions","getStorage","storageType","storageTypes","sessionCookie","idx","undefined","findStorageType","getStorageByType","getTransactionStorage","storage","storageKey","TRANSACTION_STORAGE_NAME","SavedObject","getSharedTansactionStorage","SHARED_TRANSACTION_STORAGE_NAME","getOriginalUriStorage","ORIGINAL_URI_STORAGE_NAME","getIdxResponseStorage","e","transactionStorage","getItem","key","transaction","setItem","val","AuthSdkError","setStorage","removeItem","IDX_RESPONSE_STORAGE_NAME","getTokenStorage","TOKEN_STORAGE_NAME","getHttpCache","CACHE_STORAGE_NAME","getLegacyPKCEStorage","PKCE_STORAGE_NAME","getLegacyOAuthParamsStorage","REDIRECT_OAUTH_PARAMS_NAME"],"sources":["../../lib/StorageManager.ts"],"sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * \n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n\n\nimport {\n  PKCE_STORAGE_NAME,\n  TOKEN_STORAGE_NAME,\n  TRANSACTION_STORAGE_NAME,\n  SHARED_TRANSACTION_STORAGE_NAME,\n  ORIGINAL_URI_STORAGE_NAME,\n  IDX_RESPONSE_STORAGE_NAME,\n  CACHE_STORAGE_NAME,\n  REDIRECT_OAUTH_PARAMS_NAME\n} from './constants';\nimport {\n  StorageUtil,\n  StorageProvider,\n  StorageOptions,\n  PKCEStorage,\n  CookieOptions,\n  TransactionStorage,\n  IdxResponseStorage,\n  StorageManagerOptions,\n  SimpleStorage\n} from './types';\nimport SavedObject from './SavedObject';\nimport { isBrowser } from './features';\nimport { warn } from './util';\nimport { AuthSdkError } from './errors';\n\nfunction logServerSideMemoryStorageWarning(options: StorageOptions) {\n  if (!isBrowser() && !options.storageProvider && !options.storageProvider) {\n    // eslint-disable-next-line max-len\n    warn('Memory storage can only support simple single user use case on server side, please provide custom storageProvider or storageKey if advanced scenarios need to be supported.');\n  }\n}\n\nexport class StorageManager {\n  storageManagerOptions: StorageManagerOptions;\n  cookieOptions: CookieOptions;\n  storageUtil: StorageUtil;\n\n  constructor(storageManagerOptions: StorageManagerOptions, cookieOptions: CookieOptions, storageUtil: StorageUtil) {\n    this.storageManagerOptions = storageManagerOptions;\n    this.cookieOptions = cookieOptions;\n    this.storageUtil = storageUtil;\n  }\n\n  // combines defaults in order\n  getOptionsForSection(sectionName: string, overrideOptions?: StorageOptions) {\n    return Object.assign({}, this.storageManagerOptions[sectionName], overrideOptions);\n  }\n \n  // generic method to get any available storage provider\n  // eslint-disable-next-line complexity\n  getStorage(options: StorageOptions): SimpleStorage {\n    options = Object.assign({}, this.cookieOptions, options); // set defaults\n\n    if (options.storageProvider) {\n      return options.storageProvider;\n    }\n\n    let { storageType, storageTypes } = options;\n\n    if(storageType === 'sessionStorage') {\n      options.sessionCookie = true;\n    }\n\n    // Maintain compatibility. Automatically fallback. May change in next major version. OKTA-362589\n    if (storageType && storageTypes) {\n      const idx = storageTypes.indexOf(storageType);\n      if (idx >= 0) {\n        storageTypes = storageTypes.slice(idx);\n        storageType = undefined;\n      }\n    }\n\n    if (!storageType) {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      storageType = this.storageUtil.findStorageType(storageTypes!);\n    }\n    return this.storageUtil.getStorageByType(storageType, options);\n  }\n\n  // stateToken, interactionHandle\n  getTransactionStorage(options?: StorageOptions): TransactionStorage {\n    options = this.getOptionsForSection('transaction', options);\n    logServerSideMemoryStorageWarning(options);\n    const storage = this.getStorage(options);\n    const storageKey = options.storageKey || TRANSACTION_STORAGE_NAME;\n    return new SavedObject(storage, storageKey);\n  }\n\n  getSharedTansactionStorage(options?: StorageOptions): TransactionStorage {\n    options = this.getOptionsForSection('shared-transaction', options);\n    logServerSideMemoryStorageWarning(options);\n    const storage = this.getStorage(options);\n    const storageKey = options.storageKey || SHARED_TRANSACTION_STORAGE_NAME;\n    return new SavedObject(storage, storageKey);\n  }\n\n  getOriginalUriStorage(options?: StorageOptions): TransactionStorage {\n    options = this.getOptionsForSection('original-uri', options);\n    logServerSideMemoryStorageWarning(options);\n    const storage = this.getStorage(options);\n    const storageKey = options.storageKey || ORIGINAL_URI_STORAGE_NAME;\n    return new SavedObject(storage, storageKey);\n  }\n\n  // intermediate idxResponse\n  // store for network traffic optimazation purpose\n  // TODO: revisit in auth-js 6.0 epic JIRA: OKTA-399791\n  getIdxResponseStorage(options?: StorageOptions): IdxResponseStorage | null {\n    let storage;\n    if (isBrowser()) {\n      // on browser side only use memory storage \n      try {\n        storage = this.storageUtil.getStorageByType('memory', options);\n      } catch (e) {\n        // it's ok to miss response storage\n        // eslint-disable-next-line max-len\n        warn('No response storage found, you may want to provide custom implementation for intermediate idx responses to optimize the network traffic');\n      }\n    } else {\n      // on server side re-use transaction custom storage\n      const transactionStorage = this.getTransactionStorage(options);\n      if (transactionStorage) {\n        storage = {\n          getItem: (key) => {\n            const transaction = transactionStorage.getStorage();\n            if (transaction && transaction[key]) {\n              return transaction[key];\n            }\n            return null;\n          },\n          setItem: (key, val) => {\n            const transaction = transactionStorage.getStorage();\n            if (!transaction) {\n              throw new AuthSdkError('Transaction has been cleared, failed to save idxState');\n            }\n            transaction[key] = val;\n            transactionStorage.setStorage(transaction);\n          },\n          removeItem: (key) => {\n            const transaction = transactionStorage.getStorage();\n            if (!transaction) {\n              return;\n            }\n            delete transaction[key];\n            transactionStorage.setStorage(transaction);\n          }\n        };\n      }\n    }\n\n    if (!storage) {\n      return null;\n    }\n\n    return new SavedObject(storage, IDX_RESPONSE_STORAGE_NAME);\n  }\n\n  // access_token, id_token, refresh_token\n  getTokenStorage(options?: StorageOptions): StorageProvider {\n    options = this.getOptionsForSection('token', options);\n    logServerSideMemoryStorageWarning(options);\n    const storage = this.getStorage(options);\n    const storageKey = options.storageKey || TOKEN_STORAGE_NAME;\n    return new SavedObject(storage, storageKey);\n  }\n\n  // caches well-known response, among others\n  getHttpCache(options?: StorageOptions): StorageProvider {\n    options = this.getOptionsForSection('cache', options);\n    const storage = this.getStorage(options);\n    const storageKey = options.storageKey || CACHE_STORAGE_NAME;\n    return new SavedObject(storage, storageKey);\n  }\n\n  // Will be removed in an upcoming major version. OKTA-362589\n  getLegacyPKCEStorage(options?: StorageOptions): PKCEStorage {\n    options = this.getOptionsForSection('legacy-pkce', options);\n    const storage = this.getStorage(options);\n    const storageKey = options.storageKey || PKCE_STORAGE_NAME;\n    return new SavedObject(storage, storageKey);\n  }\n\n  getLegacyOAuthParamsStorage(options?: StorageOptions): StorageProvider {\n    options = this.getOptionsForSection('legacy-oauth-params', options);\n    const storage = this.getStorage(options);\n    const storageKey = options.storageKey || REDIRECT_OAUTH_PARAMS_NAME;\n    return new SavedObject(storage, storageKey);\n  }\n}\n"],"mappings":"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"}