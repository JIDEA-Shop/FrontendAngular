{"version":3,"sources":["../../../lib/services/SyncStorageService.ts"],"names":["SyncStorageService","constructor","tokenManager","options","storageListener","bind","key","newValue","oldValue","opts","getOptions","handleCrossTabsStorageChange","resetExpireEventTimeoutAll","emitEventsForCrossTabsStorageUpdate","storageKey","syncTimeout","setTimeout","_storageEventDelay","requiresLeadership","isStarted","started","canStart","syncStorage","start","stop","window","addEventListener","removeEventListener","clearTimeout"],"mappings":";;;;;;;;AAeA;;AAfA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAGA;AAMO,MAAMA,kBAAN,CAAqD;AAM1DC,EAAAA,WAAW,CAACC,YAAD,EAA6BC,OAA8B,GAAG,EAA9D,EAAkE;AAAA,mDAF3D,KAE2D;AAC3E,SAAKD,YAAL,GAAoBA,YAApB;AACA,SAAKC,OAAL,GAAeA,OAAf;AACA,SAAKC,eAAL,GAAuB,KAAKA,eAAL,CAAqBC,IAArB,CAA0B,IAA1B,CAAvB;AACD,GAVyD,CAY1D;AACA;AACA;AACA;;;AACQD,EAAAA,eAAe,CAAC;AAAEE,IAAAA,GAAF;AAAOC,IAAAA,QAAP;AAAiBC,IAAAA;AAAjB,GAAD,EAA4C;AACjE,UAAMC,IAAI,GAAG,KAAKP,YAAL,CAAkBQ,UAAlB,EAAb;;AAEA,UAAMC,4BAA4B,GAAG,MAAM;AACzC,WAAKT,YAAL,CAAkBU,0BAAlB;AACA,WAAKV,YAAL,CAAkBW,mCAAlB,CAAsDN,QAAtD,EAAgEC,QAAhE;AACD,KAHD,CAHiE,CAQjE;AACA;AACA;AACA;;;AACA,QAAIF,GAAG,KAAKA,GAAG,KAAKG,IAAI,CAACK,UAAb,IAA2BP,QAAQ,KAAKC,QAA7C,CAAP,EAA+D;AAC7D;AACD,KAdgE,CAgBjE;AACA;;;AACA,SAAKO,WAAL,GAAmBC,UAAU,CAAC,MAAML,4BAA4B,EAAnC,EAAuCF,IAAI,CAACQ,kBAA5C,CAA7B;AACD;;AAEDC,EAAAA,kBAAkB,GAAG;AACnB,WAAO,KAAP;AACD;;AAEDC,EAAAA,SAAS,GAAG;AACV,WAAO,KAAKC,OAAZ;AACD;;AAEDC,EAAAA,QAAQ,GAAG;AACT,WAAO,CAAC,CAAC,KAAKlB,OAAL,CAAamB,WAAf,IAA8B,0BAArC;AACD;;AAEDC,EAAAA,KAAK,GAAG;AACN,QAAI,KAAKF,QAAL,EAAJ,EAAqB;AACnB,WAAKG,IAAL;AACAC,MAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmC,KAAKtB,eAAxC;AACA,WAAKgB,OAAL,GAAe,IAAf;AACD;AACF;;AAEDI,EAAAA,IAAI,GAAG;AACL,QAAI,KAAKJ,OAAT,EAAkB;AAChB;AACAK,MAAAA,MAAM,CAACE,mBAAP,CAA2B,SAA3B,EAAsC,KAAKvB,eAA3C;AACAwB,MAAAA,YAAY,CAAC,KAAKb,WAAN,CAAZ;AACA,WAAKK,OAAL,GAAe,KAAf;AACD;AACF;;AAhEyD","sourcesContent":["/*!\n * Copyright (c) 2015-present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * \n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n\n/* global window */\nimport { TokenManager } from '../TokenManager';\nimport { isBrowser } from '../features';\nimport { ServiceManagerOptions, ServiceInterface } from '../types';\n\n\nexport class SyncStorageService implements ServiceInterface {\n  private tokenManager: TokenManager;\n  private options: ServiceManagerOptions;\n  private syncTimeout: unknown;\n  private started = false;\n\n  constructor(tokenManager: TokenManager, options: ServiceManagerOptions = {}) {\n    this.tokenManager = tokenManager;\n    this.options = options;\n    this.storageListener = this.storageListener.bind(this);\n  }\n\n  // Sync authState cross multiple tabs when localStorage is used as the storageProvider\n  // A StorageEvent is sent to a window when a storage area it has access to is changed \n  // within the context of another document.\n  // https://developer.mozilla.org/en-US/docs/Web/API/StorageEvent\n  private storageListener({ key, newValue, oldValue }: StorageEvent) {\n    const opts = this.tokenManager.getOptions();\n\n    const handleCrossTabsStorageChange = () => {\n      this.tokenManager.resetExpireEventTimeoutAll();\n      this.tokenManager.emitEventsForCrossTabsStorageUpdate(newValue, oldValue);\n    };\n\n    // Skip if:\n    // not from localStorage.clear (event.key is null)\n    // event.key is not the storageKey\n    // oldValue === newValue\n    if (key && (key !== opts.storageKey || newValue === oldValue)) {\n      return;\n    }\n\n    // LocalStorage cross tabs update is not synced in IE, set a 1s timer by default to read latest value\n    // https://stackoverflow.com/questions/24077117/localstorage-in-win8-1-ie11-does-not-synchronize\n    this.syncTimeout = setTimeout(() => handleCrossTabsStorageChange(), opts._storageEventDelay);\n  }\n\n  requiresLeadership() {\n    return false;\n  }\n\n  isStarted() {\n    return this.started;\n  }\n\n  canStart() {\n    return !!this.options.syncStorage && isBrowser();\n  }\n\n  start() {\n    if (this.canStart()) {\n      this.stop();\n      window.addEventListener('storage', this.storageListener);\n      this.started = true;\n    }\n  }\n\n  stop() {\n    if (this.started) {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      window.removeEventListener('storage', this.storageListener!);\n      clearTimeout(this.syncTimeout as any);\n      this.started = false;\n    }\n  }\n} "],"file":"SyncStorageService.js"}